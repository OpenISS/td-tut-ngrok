<!DOCTYPE html>
<html>
<head>
	<title>TD Remote</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<style>
		body { margin: 0; padding-bottom: 2em; overflow: hidden; }
		#trackpad {
			width: 100%; max-width: 600px; height: 100vw; max-height: 600px;
			box-sizing: border-box; margin: 0 auto; background-color: rgba(200,200,200,1);
			position: relative; display: flex; color: rgba(162,162,162,1); }
		#trackpad:before {
			content: attr(data-label); margin: auto; font-size: 12vw; font-family: monospace; }
		#event_log { text-align: center; }
		@media screen and (min-width: 600px) {
			#trackpad:before { font-size: 5em; }
		}
	</style>
</head>
<body>
	<div id="trackpad" data-label="TRACKPAD"></div>
	<p id="event_log"></p>
	<script>
	(() => {
		const socket = new WebSocket("ws://6fada9ca.ngrok.io")
		const trackpad = document.querySelector("#trackpad")
		const log = document.querySelector("#event_log")
		const handleTrackpad = (user, target) => {
			const { u, v } = formatUV([
				(user.clientX - target.offsetLeft) / target.clientWidth,
				(user.clientY - target.offsetTop) / target.clientHeight,
			])
			const json = JSON.stringify({type: "player:trackpad", u, v})
			socket.send(json)
		}

		socket.onmessage = (event) => log.innerHTML = event.data 

		trackpad.ontouchmove = (event) => handleTrackpad(event.targetTouches[0], event.target)
		trackpad.ontouchstart = (event) => handleTrackpad(event.targetTouches[0], event.target)
		trackpad.onmousedown = (event) => {
			handleTrackpad(event.targetTouches[0])
			trackpad.onmousemove = handleTrackpad(event, event.target)
			window.mouseup = () => trackpad.onmousemove = null
		}

		function formatUV(/*Array*/ uv) {
			// Helper function normalizes coordinates to -1<>1 and rounds for precision
			// TD expects panel values to increase bottom --> up, so we'll invert our v here
			return {
				u: (uv[0] * 2 - 1).toFixed(2),
				v: (uv[1] * -2 + 1).toFixed(2),
			}
		}
	})()
	</script>
</body>
</html>
